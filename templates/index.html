<!DOCTYPE html>
<html>
    <head>
        <META HTTP-EQUIV="Pragma"CONTENT="no-cache">
        <META HTTP-EQUIV="Cache-Control"CONTENT="no-cache">
        <META HTTP-EQUIV="Expires"CONTENT="0">
        <meta charset="utf-8">
        <script src="https://d3js.org/d3.v4.js"></script>
		<script src="https://unpkg.com/d3@5.6.0/dist/d3.min.js"></script>
        <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/echarts.min.js"></script>
        <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts-gl/echarts-gl.min.js"></script>
        <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts-stat/ecStat.min.js"></script>
        <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/extension/bmap.min.js"></script>
        <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/simplex.js"></script>
        <script type="text/javascript" src="../static/scripts/dark.js"></script>
        <script src="../static/scripts/d3.layout.cloud.js"></script>
        <script src="../static/scripts/d3-legend.min.js"></script>
        <script scr="../static/scripts/D1per10min.js"></script>
        <script src = "../static/scripts/DrawRoute.js"></script>
        <script src = "../static/scripts/DrawTable.js"></script>
        <script src = "../static/scripts/d1transferper10min.js"></script>
        <script src = "../static/scripts/d2transferper10min.js"></script>
        <script src = "../static/scripts/d3transferper10min.js"></script>
		<script src = "../static/scripts/d1labelcountper10min.js"></script>
		<script src = "../static/scripts/d2labelcountper10min.js"></script>
		<script src = "../static/scripts/d3labelcountper10min.js"></script>
		<script src = "../static/scripts/d1labelcountpermin.js"></script>
		<script src = "../static/scripts/d2labelcountpermin.js"></script>
		<script src = "../static/scripts/d3labelcountpermin.js"></script>
        <script src = "../static/scripts/number_time_day1.js"></script>
        <script src = "../static/scripts/number_time_day2.js"></script>
        <script src = "../static/scripts/number_time_day3.js"></script>
    	<script src = "../static/scripts/sensor_deployment.js"></script>
        <script src = "../static/scripts/id_label.js"></script>
        <script src = "../static/scripts/D1permin.js"></script>
        <script src = "../static/scripts/D2permin.js"></script>
        <script src = "../static/scripts/D3permin.js"></script>
        <script src = "../static/scripts/D1per10min.js"></script>
        <script src = "../static/scripts/D2per10min.js"></script>
        <script src = "../static/scripts/D3per10min.js"></script>
    	<!-- <script src = "../static/scripts/sensor_deployment.js"></script> -->
        <script src = "../static/scripts/DrawBubble.js"></script>
        <script src = "../static/data/day_cluster.js"></script>
        <script src = "../static/data/day1_cluster.js"></script>
        <script src = "../static/data/day2_cluster.js"></script>
        <script src = "../static/data/day3_cluster.js"></script>
        <script src = "../static/scripts/DrawChord.js"></script>
        <script src="../static/scripts/DrawProportion.js"></script>
				<script src = "../static/scripts/DrawWordCloud.js"></script>
        <script src="../static/data/proportion.js"></script>
        <link href="../static/css/style.css"  rel="stylesheet" type="text/css" media="all" />
        <style>
            /*#day_route{*/
                /*background: url(https://github.com/Angeladadd/ChinaVis2019/blob/cc86772a65976d4ad933450d589f0790444a1042/static/img/background.png);*/
            /*}*/
        </style>
        <script>
            var currentDay = 0;
            data_day1 = {{data_day1|tojson}}
            data_day2 = {{data_day2|tojson}}
            data_day3 = {{data_day3|tojson}}
            sensor_deployment = {{sensor|tojson}}
            //基本数据
            var sensor = {x_max:15,x_min:0,y_max:28,y_min:0};
            BASIC_DATA = {sensor:sensor,people_MAX:25};
            var people_map = {};
            var sensor_map = {};
            for(var i=0;i<sensor_deployment.length;i++){
                sensor_map[sensor_deployment[i].sid] = i;
            }
            //统计一天的people，目前只处理了第一天的，还不知道这个代码到时候放哪
            //这个地方非常瓶颈，建议后端直接做成json，后端如果要加的话尽量把people做成这个数据结构8
            people = new Array(3);
            people[0] = new Array(0);
            people[1] = new Array(0);
            people[2] = new Array(0);
            var cnt = -1;
            //为了加载快，这里只计算一天
            //第二天修改所有的people[0]为 people[1], data_day1为data_day2
            for(var i=0;i<data_day1.length;i++){
                let id = data_day1[i].id;
                let sid = data_day1[i].sid;
                let time = data_day1[i].time;
                var d_obj;
                if(!people_map.hasOwnProperty(id)){
                    cnt++;
                    people_map[id] = cnt;
                    people[0][cnt] = new Array(0);
                    d_obj = {};
                    var sensor_tmp = sensor_deployment[sensor_map[sid]];
                    d_obj.x = parseInt(-1);
                    d_obj.y = parseInt(-1);
                    d_obj.floor = parseInt(sensor_tmp.floor);
                    d_obj.time = parseInt(time);
                    d_obj.id = parseInt(id);
                    d_obj.sensor_simple_id = sensor_map[sid];
                    people[0][cnt].push(d_obj);
                }
                var index = parseInt(people_map[id]);
                var obj = {};
                var sensor_tmp = sensor_deployment[sensor_map[sid]];
                obj.x = parseInt(sensor_tmp.x);
                obj.y = parseInt(sensor_tmp.y);
                obj.floor = parseInt(sensor_tmp.floor);
                obj.time = parseInt(time);
                obj.id = parseInt(id);
                obj.sensor_simple_id = sensor_map[sid];
                if(people[0][index]) people[0][index].push(obj);
            }
            for(var i=0;i<people[0].length;i++)
                people[0][i].push(d_obj);
            MAP = {people_map:people_map,sensor_map:sensor_map};
            sensor_all_floor = new Array(0);
            for(let i=0;i<sensor_deployment.length;i++){
                sensor_all_floor.push(sensor_deployment[i]);
            }
        </script>
    </head>

    <body>
        <div class="wpbox">
            <div class="bnt">
                <div class="topbnt_left fl">
                    <ul>
                        <li class="active"><a href="#">警情警力</a></li>
                        <li><a href="#">实有人口</a></li>
                        <li><a href="#">流动人口</a></li>
                        <li><a href="#">实名制</a></li>
                    </ul>
                </div>

                <h1 class="tith1 fl">China Vis 2019</h1>
                <div class=" fr topbnt_right">
                    <ul>
                        <li value="0" onclick="ChangeDay(value)" style="cursor: pointer"> 自定义 </li>
                        <li value="2" onclick="ChangeDay(value)" style="cursor: pointer"> 第三天 </li>
                        <li value="1" onclick="ChangeDay(value)" style="cursor: pointer"> 第二天 </li>
                        <li value="0" onclick="ChangeDay(value)" style="cursor: pointer"> 第一天 </li>
                    </ul>
                </div>
            </div>


            <div class="left1">
                <div class="aleftboxttop"><h2 class="tith2">今日矛盾纠纷数据统计</h2>
                    <div class="lefttoday_tit" style=" height:100%">
                        <table width="260" border="1" id="table">
                         <tr>
                          <th align="middle">Region</th>
                          <th align="middle">flow</th>
                         </tr>
                         <tr>
                          <td align="midlle" id = "th11"></td>
                          <td align="middle" id = "th12"></td>
                         </tr>
                         <tr>
                          <td align="middle" id = "th21"></td>
                          <td align="middle" id = "th22"></td>
                         </tr>
                         <tr>
                          <td align="middle"id = "th31"></td>
                          <td align="middle" id = "th32"></td>
                         </tr>
                            <tr>
                          <td align="middle" id = "th41"></td>
                          <td align="middle" id = "th42"></td>
                         </tr>
                            <tr>
                          <td align="middle" id = "th51"></td>
                          <td align="middle" id = "th52"></td>
                         </tr>
                        </table>
                    </div>

                </div>

                <div class="aleftboxtmidd">
                    <h2 class="tith2">出席天数统计</h2>
                    <!--<div id="aleftboxtmidd" class="aleftboxtmiddcont">-->
                        <svg id="proportion"></svg>
                        <button value="scholar" onclick="changeClass(this.value)">scholar</button>
                        <button value="reporter" onclick="changeClass(this.value)">reporter</button>
                        <button value="business" onclick="changeClass(this.value)">business</button>
                        <button value="attendee" onclick="changeClass(this.value)">attendee</button>
                        <button value="visitor" onclick="changeClass(this.value)">visitor</button>
                        <button value="cook" onclick="changeClass(this.value)">only for meal</button>
                        <button value="waiter" onclick="changeClass(this.value)">waiter</button>
                        <button value="assistant" onclick="changeClass(this.value)">assistant</button>
                    <!--</div>-->
                </div>

                <div class="aleftboxtbott">
                    <h2 class="tith2">矛盾纠纷类型统计</h2>

                    <div id="aleftboxtbott" class="aleftboxtbott_cont" >
                        <div id="chord">
                            <svg width="240" height="240"></svg>
                        </div>
                    </div>
                </div>
            </div>


            <div class="mrbox">
                <div class="mrbox_topmidd" style="width: 69%;">
                    <div class="amiddboxttop">
                        <h2 class="tith2 pt1">实时监控统计</h2>
                        <div class="amiddboxttop_map">
                            <div id="main_active">
                                <svg id="day_route" class="day_route"></svg>
                                <p id="time"></p>
                                start:<input type="text" id="start_time" onchange="changeStartTime(this.value)">
                                end:<input type="text" id="end_time" onchange="changeEndTime(this.value)">
                                day:<input type="text" id="day" onchange="changeDay(this.value)">
                                <button onclick="runRoute()">run</button>
                                <p id ="list"></p>
                                <!--<button value="all" onclick="ChangeLabelChoose(value)">all</button>-->
                                <!--<button value = 'ordinary worker' onclick="ChangeLabelChoose(value)">ordinary worker</button>-->
                                <!--<button value = 'manager' onclick="ChangeLabelChoose(value)">manager</button>-->
                                <!--<button value = 'reporter' onclick="ChangeLabelChoose(value)">reporter</button>-->
                                <!--<button value = 'guest' onclick="ChangeLabelChoose(value)">guest</button>-->
                                <!--<button value = 'attendee' onclick="ChangeLabelChoose(value)">attendee</button>-->
                            </div>
                        </div>
                    </div>

                    <div class="amidd_bott">
                        <div class="amiddboxtbott1 fl" >
                            <h2 class="tith2 pt1">矛盾纠纷环比分析</h2>

                            <div id="amiddboxtbott1" class="amiddboxtbott1content" >
                                <div id="bubble">
                                    <svg width="350" height="250" font-family="sans-serif" font-size="10" text-anchor="middle"></svg>
                                </div>
                            </div>
                        </div>

                        <div class="amiddboxtbott2 fl">
                            <h2 class="tith2 pt1">最长逗留时间分布</h2>
                            <div class="amiddboxtbott2content">
                                <div id="containerlyx2" style="height: 100%"></div>
                                <script src = "../static/scripts/people_time.js"></script>
                                <script src = "../static/scripts/DrawScatter.js"></script>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mrbox_top_right">
                    <div class="arightboxtop">
                        <h2 class="tith2">人员分布统计图</h2>
                        <script src="../static/scripts/DrawBarPre.js"></script>
                        <!-- <h3 class="tith2"> Day 1 </h3> -->
                        <div id="containerlyx11" style="height: 100%"></div>
                        <script src="../static/scripts/DrawBar1.js"></script>

                        <!-- <h3 class="tith2"> Day 2 </h3> -->
                        <div id="containerlyx12" style="height: 100%"></div>
                        <script src="../static/scripts/DrawBar2.js"></script>

                        <!-- <h3 class="tith2"> Day 3 </h3> -->
                        <div id="containerlyx13" style="height: 100%"></div>
                        <script src="../static/scripts/DrawBar3.js"></script>

                        <script>
                            var dom = document.getElementById("containerlyx11");
                            dom.style.display = "";
                            var dom = document.getElementById("containerlyx12");
                            dom.style.display = "none";
                            var dom = document.getElementById("containerlyx13");
                            dom.style.display = "none";
                        </script>
                    </div>

                    <div class="arightboxbott">
                        <h2 class="tith2 ">人员构成</h2>
                        <div id="arightboxbott" class="arightboxbottcont">
                            <div id="person_distribution"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
<!--<script>-->
<!--    var data = [];-->
<!--    for(i in D1per10min){-->
<!--        var tmp = {region:i,flow:D1per10min[i][0]};-->
<!--        console.log(tmp);-->
<!--        data.push(tmp);-->
<!--    }-->
<!--    console.log(data);-->
<!--    data.sort(function(a,b){-->
<!--			return  b.flow - a.flow;-->
<!--		});-->
<!--    console.log(data);-->
<!--    document.getElementById("th11").innerText = data[0].region;-->
<!--    document.getElementById("th12").innerText = data[0].flow;-->
<!--    document.getElementById("th21").innerText = data[1].region;-->
<!--    document.getElementById("th22").innerText = data[1].flow;-->
<!--    document.getElementById("th31").innerText = data[2].region;-->
<!--    document.getElementById("th32").innerText = data[2].flow;-->
<!--    document.getElementById("th41").innerText = data[3].region;-->
<!--    document.getElementById("th42").innerText = data[3].flow;-->
<!--    document.getElementById("th51").innerText = data[4].region;-->
<!--    document.getElementById("th52").innerText = data[4].flow;-->

<!--</script>-->

        <script>
            label_choose = 'all';
            function ChangeLabelChoose(val){
                label_choose = val;
            }
            function ChangeDay(val){
                val=parseInt(val);
                currentDay = val;
                world_cloud.update_by_day(val);
                console.log(val);
                changeBar(val);
            }
            //drawFlow();
            // drawBubble(1,24700);
            var proportion_obj = DrawProportion();
            var world_cloud = DrawWorldCloud(0);
            //world_cloud.update_by_day(1);
            //第二天修改为2
            route = drawMainActive(0,37000);
            drawBubble(1,37000);
            drawChord(1,37000);
            drawTable(1,37000);
            var tmp =0;
            function Update(currentTime){
                // {#console.log(currentTime);#}
                //console.log(currentTime);
                route.update(currentTime);
                tmp++;
                if(tmp == 60){
                    var svg_bubble = d3.select('#bubble').select('svg');
                    var svg_chord = d3.select('#chord').select("svg");
                    svg_bubble.selectAll('*').remove();
                    svg_chord.selectAll('*').remove();
                    drawBubble(1,currentTime);
                    drawChord(1,currentTime);
                    drawTable(1,currentTime);
                    tmp =0;
                    console.log("change!!!!")
                }
            }
            function changeStartTime(val){
                tmp_currentTime = val;
            }
            function changeEndTime(val){
                tmp_endTime = val;
            }
            function changeDay(val){
                tmp_day=val;
            }
            function runRoute(){
                currentTime = tmp_currentTime;
                endTime = tmp_endTime;
                route = drawMainActive(tmp_day,currentTime);
            }
            function changeBar(val){
                console.log(val);
                if(val == 0){
                    var dom = document.getElementById("containerlyx11");
                    dom.style.display = "";
                    var dom = document.getElementById("containerlyx12");
                    dom.style.display = "none";
                    var dom = document.getElementById("containerlyx13");
                    dom.style.display = "none";

                    // new_element=document.createElement("script");
                    // new_element.setAttribute("type","text/javascript");
                    // new_element.setAttribute("src","../static/scripts/DrawBar1.js");
                    // document.body.appendChild(new_element);
                }
                if(val == 1){
                    var dom = document.getElementById("containerlyx11");
                    dom.style.display = "none";
                    var dom = document.getElementById("containerlyx12");
                    dom.style.display = "";
                    var dom = document.getElementById("containerlyx13");
                    dom.style.display = "none";

                    // new_element=document.createElement("script");
                    // new_element.setAttribute("type","text/javascript");
                    // new_element.setAttribute("src","../static/scripts/DrawBar2.js");
                    // document.body.appendChild(new_element);
                }
                if(val == 2){
                    var dom = document.getElementById("containerlyx11");
                    dom.style.display = "none";
                    var dom = document.getElementById("containerlyx12");
                    dom.style.display = "none";
                    var dom = document.getElementById("containerlyx13");
                    dom.style.display = "";

                    // new_element=document.createElement("script");
                    // new_element.setAttribute("type","text/javascript");
                    // new_element.setAttribute("src","../static/scripts/DrawBar3.js");
                    // document.body.appendChild(new_element);
                }
            }
        </script>
    </body>

    <script>
        //当天的开始时间,修改这个要同时修改DrawMain的第二个参数
        currentTime = 42000;
        endTime = 45164;
        //flag=true;
        var currentDay = 2;
            setTimeout(function () {
                //if(!flag) return;
                //当天的结束时间
            if(currentTime<endTime){
                //console.log(currentTime);
                var p=document.getElementById("time");
                p.innerHTML = currentTime.toString();
            Update(currentTime);
            currentTime++;
            setTimeout(arguments.callee, 0.1)
            }
            else currentTime = 27070;
        },0.1);
    </script>

</html>
