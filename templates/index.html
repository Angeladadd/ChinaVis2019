<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script src="https://d3js.org/d3.v4.js"></script> 
        <script src="https://unpkg.com/d3@5.6.0/dist/d3.min.js"></script>
        <script src="../static/scripts/d3-legend.min.js"></script>
	    <script src = "../static/scripts/DrawFlow.js"></script>
        <script src = "../static/scripts/number_time_day1.js"></script>
        <script src = "../static/scripts/number_time_day2.js"></script>
        <script src = "../static/scripts/number_time_day3.js"></script>
        <script src = "../static/scripts/DrawRoute.js"></script>
    	<script src = "../static/scripts/sensor_deployment.js"></script>
        <script src = "../static/scripts/DrawBubble.js"></script>
        <script>
         
            data_day1 = {{data_day1|tojson}}
            data_day2 = {{data_day2|tojson}}
            data_day3 = {{data_day3|tojson}}
            //基本数据
            var sensor = {x_max:15,x_min:0,y_max:28,y_min:0};
            BASIC_DATA = {sensor:sensor,people_MAX:20};
            var people_map = {};
            var sensor_map = {};

            for(var i=0;i<Object.keys(sensor_deployment).length;i++){
                sensor_map[sensor_deployment[i].sid] = i;
            }
            //统计一天的people，目前只处理了第一天的，还不知道这个代码到时候放哪
            //这个地方非常瓶颈，建议后端直接做成json，后端如果要加的话尽量把people做成这个数据结构8
            people = new Array(3);
            people[0] = new Array(0);
            var cnt = -1;
            for(var i=0;i<data_day1.length;i++){
                let id = data_day1[i].id;
                let sid = data_day1[i].sid;
                let time = data_day1[i].time;
                if(!people_map.hasOwnProperty(id)){
                    cnt++;
                    people_map[id] = cnt;
                    people[0][cnt] = new Array(0);
                }
                var index = parseInt(people_map[id]);

                var obj = {};
                var sensor_tmp = sensor_deployment[sensor_map[sid]];
                obj.x = parseInt(sensor_tmp.x);
                obj.y = parseInt(sensor_tmp.y);
                obj.floor = parseInt(sensor_tmp.floor);
                obj.time = parseInt(time);
                obj.sensor_simple_id = sensor_map[sid];

                if(people[0][index]) people[0][index].push(obj);
            }

            MAP = {people_map:people_map,sensor_map:sensor_map};
            //基本信息处理
            //一楼的sensor
            sensor_floor1 = new Array(0);
            //二楼的sensor
            sensor_floor2 = new Array(0);
            for(let i=0;i<Object.keys(sensor_deployment).length;i++){
                if(sensor_deployment[i].floor == "1")
                    sensor_floor1.push(sensor_deployment[i]);
                else
                    sensor_floor2.push(sensor_deployment[i]);
            }


        </script>
    </head>

    <body>
    <div id="liuyuxiang">
            <select id="selectButton"></select>
            <div id="vis1"></div>
    </div>

    <div id="bubble">
		<svg width="100%" height="700" font-family="sans-serif" font-size="10" text-anchor="middle"></svg>
	</div>





    <div id="main_active">
        <svg id="day_route"></svg>
    </div>

        <script>
        drawFlow();
function drawMainActive(day_index, floor_index){
    //处理参数
    var day = 0;
    switch(day_index) {
        case 1:
            day = 0;
            break;
            case 2:
                day = 1;
                break;
                case 3:
                    day = 2;
                    break;
            }
            var sensor;
            switch (floor_index) {
                case 1:
                    sensor = sensor_floor1;
                    break;
                case 2:
                    sensor = sensor_floor2;
                    break;
            }
            //布局
            //给的地图太智障了，我强行把x换成了y
            let margin = {top: 10, right: 30, bottom: 30, left: 60},
                width = 400 - margin.left - margin.right,
                height = 600 - margin.top - margin.bottom;
            let svg = d3.select("#day_route")
                .attr("height", width + margin.left + margin.right)
                .attr("width", height + margin.top + margin.bottom);
            let xLinear = d3.scaleLinear()
                .domain([BASIC_DATA.sensor.x_min, BASIC_DATA.sensor.x_max])
                .range([10,width]);
            let yLinear = d3.scaleLinear()
                .domain([BASIC_DATA.sensor.y_min,BASIC_DATA.sensor.y_max])
                .range([10,height]);
            var sensor_people = new Array(0);
            var sensor_width= 15;
            var color1=d3.rgb(255,240,240);
            var color2=d3.rgb(255,50,50);
            var compute=d3.interpolate(color1,color2);
            var color_linear=d3.scaleLinear()
            .domain([0, BASIC_DATA.people_MAX])
            .range([0,1]);
            svg.selectAll(".sensor")
                .data(sensor)
                .enter()
                .append("rect")
                .attr("class","sensor")
                .attr("id", function (d,i) {
                    sensor_people[i] = 0;
                    return "sensor"+i.toString();
                })
                .attr("y",function (d) {
                    return xLinear(d.x)-sensor_width/2;
                })
                .attr("x",function (d) {
                    return yLinear(d.y)-sensor_width/2;
                })
                .attr("width",sensor_width)
                .attr("height",sensor_width)
                .attr("fill", color1)
                .style("opacity",0.5);
            svg.selectAll(".position")
                .data(people[day])
                .enter()
                .append("circle")
                .attr("class","position")
                .attr("cy", function (d,i) {
                    //var new_sensor = d[0].sensor_simple_id;
                    //sensor_people[new_sensor] += 1;
                    return xLinear(d[0].x);})
                .attr("cx", function (d,i) {
                    return yLinear(d[0].y);})
                .attr("r",2)
                .style("fill", "blue")
                .style("opacity",function (d,i) {
                    return 1;});

            var obj = {};
            obj.svg = svg;
            obj.people = people[day];
            // var terminal = "terminal";
            // for(var i=0;i<people[day].length;i++){
            //     people[day][i].push(terminal);
            // }
            obj.point = new Array(people[day].length);
            obj.sensor = sensor;
            for(var i=0;i<people[day].length;i++){
                obj.point[i] = 0;
            }
            obj.update = function (currentTime){
                //console.log("!");
                for(var i=0;i<this.people.length;i++){
                    if(!this.people[i][this.point[i]+1]) continue;
                    if(this.people[i][this.point[i]+1].time == currentTime) {
                        var old_sensor = this.people[i][this.point[i]].sensor_simple_id;
                        var new_sensor = this.people[i][this.point[i]+1].sensor_simple_id;
                        if(this.point[i]!= 0) sensor_people[old_sensor] -= 1;
                        sensor_people[new_sensor] += 1;
                        d3.select("#sensor"+old_sensor.toString())
                            .attr("fill", compute(color_linear(sensor_people[old_sensor])));
                        d3.select("#sensor"+new_sensor.toString())
                            .attr("fill", compute(color_linear(sensor_people[new_sensor])));
                        this.point[i]+=1;
                    }
                //     else{
                //         var old_sensor = this.people[i][this.point[i]].sensor_simple_id;
                //         if(this.point[i]!= 0) sensor_people[old_sensor] -= 1;
                //         d3.select("#sensor"+old_sensor.toString())
                //             .attr("fill", compute(color_linear(sensor_people[old_sensor])));
                //         this.point[i]+=1;
                //     }
                }
                var point = this.point;
                this.svg.selectAll(".position")
                    .transition()
                    .duration(100)
                    .attr("cy", function (d,i) {
                        return xLinear(d[point[i]].x);})
                    .attr("cx", function (d,i) {
                        return yLinear(d[point[i]].y);})
                    .attr("r",function (d,i) {
                        // if(d[point[i]]==terminal)
                        //     return 0;
                        // else
                        return 2;
                    })
                    .style("fill", "blue")
                    .style("opacity",function (d,i) {
                        return 1;});
            };
            return obj;
}
var route = drawMainActive(1,1);
function Update(currentTime){
    {#console.log(currentTime);#}
    route.update(currentTime);
}
        drawBubble();

        </script>
    </body>
<script>

  var currentTime = 25240;
  setTimeout(function () {
    if(currentTime<31270){
      Update(currentTime);
      currentTime++;
      setTimeout(arguments.callee, 10)
    }
  },10);
</script>
</html>
